<div class="container">

  <header class="header">
    <mat-icon class="header__button" routerLink="/dashboard">exit_to_app</mat-icon>
    <h2 class="header__title">{{ titleForm }}</h2>
  </header>

  <form [formGroup]="dynamicForm" (ngSubmit)="onSubmit()" class="form">
    <div *ngFor="let section of sections; let idx = index" class="form__section">

      <div *ngFor="let field of section.fields" class=""
        [class.dynamic-form__field--wide]="field.type === 'textarea' || field.type === 'file' || field.type === 'qrcode' || field.type === 'geolocation'"
        [class.dynamic-form__field--error]="isFieldInvalid(field.name)">

        <div class="form__field">
          <label class="form__label" [for]="field.name">
            {{ field.label }}
            <span *ngIf="field.required" class="required-asterisk">*</span>
          </label>

          <!-- Text Input -->
          <input *ngIf="field.type === 'text' && !field.mask" [id]="field.name" type="text"
            [formControlName]="field.name" class="form__input" [placeholder]="field.placeholder">

          <!-- Text Input with Mask -->
          <input *ngIf="field.type === 'text' && field.mask" [id]="field.name" type="text"
            [formControlName]="field.name" [mask]="field.mask" class="form__input" [placeholder]="field.placeholder">

          <!-- Email Input -->
          <input *ngIf="field.type === 'email'" [id]="field.name" type="email" [formControlName]="field.name"
            class="form__input" [placeholder]="field.placeholder">

          <!-- Tel Input -->
          <input *ngIf="field.type === 'tel'" [id]="field.name" type="tel" [formControlName]="field.name"
            [mask]="field.mask || ''" class="form__input" [placeholder]="field.placeholder">

          <!-- Date Input -->
          <input *ngIf="field.type === 'date'" [id]="field.name" type="date" [formControlName]="field.name"
            class="form__input">

          <!-- Number Input -->
          <input *ngIf="field.type === 'number'" [id]="field.name" type="number" [formControlName]="field.name"
            [min]="field.min ?? null" [max]="field.max ?? null" class="form__input" [placeholder]="field.placeholder">

          <!-- Select -->
          <select *ngIf="field.type === 'select'" [id]="field.name" [formControlName]="field.name" class="form__input">
            <option value="">Selecione...</option>
            <option *ngFor="let option of field.options" [value]="option">
              {{ option }}
            </option>
          </select>

          <input *ngIf="field.type === 'checkbox'" [id]="field.name" type="checkbox">

          <!-- Textarea -->
          <textarea *ngIf="field.type === 'textarea'" [id]="field.name" [formControlName]="field.name" rows="4"
            class="form__input" [placeholder]="field.placeholder">
            </textarea>

          <!-- File Input -->
          <div *ngIf="field.type === 'file'" class="form__field-flex">
            <span class="form__input">
              {{ uploadedFiles[field.name] ? uploadedFiles[field.name].name : 'Clique para selecionar arquivo' }}
            </span>
            <label [for]="field.name" class="form__field-button">
              <mat-icon>image</mat-icon>
            </label>
            <input [id]="field.name" type="file" [name]="field.name" [accept]="field.accept"
              (change)="handleFileChange($event, field.name)" class="form__input-file">
          </div>

          <!-- QR Code Scanner -->
          <div *ngIf="field.type === 'qrcode'" class="form__scanner">
            <div class="form__field-flex">
              <input [id]="field.name" type="text" [formControlName]="field.name" [placeholder]="field.placeholder"
                class="form__input">
              <button type="button" (click)="startQrScanner(field.name)" class="form__field-button">
                <mat-icon>qr_code</mat-icon>
              </button>
            </div>
            <div *ngIf="qrScannerActive[field.name]" class="scanner">
              <video [id]="'qr-video-' + field.name" class="scanner__cam" playsinline></video>
              <button type="button" (click)="stopQrScanner(field.name)" class="scanner__close">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <!-- Geolocation -->
          <div *ngIf="field.type === 'geolocation'" class="form__field-flex">
            <input [id]="field.name" type="text" [formControlName]="field.name" class="form__input"
              [placeholder]="field.placeholder" readonly>
            <button type="button" (click)="getGeolocation(field.name)" [disabled]="geoLocationLoading[field.name]"
              class="form__field-button">
              <mat-icon>{{ geoLocationLoading[field.name] ? 'hourglass_empty' : 'my_location' }}</mat-icon>
            </button>
          </div>
        </div>

        <!-- Error Message -->
        <span *ngIf="isFieldInvalid(field.name)" class="form__field-error">
          {{ getFieldError(field.name) }}
        </span>
      </div>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="form__button" [disabled]="submissionState === FormSubmissionState.LOADING">
      <span *ngIf="submissionState !== FormSubmissionState.LOADING">{{ submitButtonText }}</span>
      <span *ngIf="submissionState === FormSubmissionState.LOADING">Aguarde...</span>
    </button>
  </form>

  <!-- Loading Overlay -->
  <div *ngIf="submissionState === FormSubmissionState.LOADING" class="overlay">
    <div class="loading__spinner"></div>
    <p class="loading__title">Processando...</p>
  </div>

  <!-- Success Modal -->
  <div *ngIf="submissionState === FormSubmissionState.SUCCESS" class="overlay">
    <div class="modal">
      <div class="modal__icon modal__icon-success">
        <mat-icon>check</mat-icon>
      </div>
      <h3 class="modal__title">{{ successMessage }}</h3>

      <!-- QR Code Actions -->
      <div *ngIf="qrCode" class="modal__qrcode-actions">
        <button type="button" (click)="downloadQRCode()" class="modal__button modal__button-success">
          <mat-icon>download</mat-icon>
          Baixar QR Code
        </button>
        <button type="button" (click)="shareQRCode()" class="modal__button modal__button-success">
          <mat-icon>share</mat-icon>
          Compartilhar
        </button>
      </div>
      <button type="button" class="modal__button modal__button-success" routerLink="/dashboard">
        In√≠cio
      </button>
    </div>
  </div>

  <!-- Error Modal -->
  <div *ngIf="submissionState === FormSubmissionState.ERROR" class="overlay">
    <div class="modal">
      <div class="modal__icon modal__icon-error">
        <mat-icon>block</mat-icon>
      </div>
      <h3 class="modal__title">{{ errorMessage }}</h3>
      <button type="button" (click)="closeMessage()" class="modal__button modal__button-error">
        Tentar Novamente
      </button>
    </div>
  </div>
</div>
